{% from 'message_box.html' import message_box %}

{% macro event_list(events_by_month, format_event_date, is_recent, happening_now, category, future_event_count,
                    past_event_count, future_threshold, past_threshold, show_future_events=false,
                    show_past_events=false, has_hidden_events=false, is_flat=false, request_params={}) %}
    {#- request_params parameter provided for template extensions -#}
    {% if has_hidden_events %}
        {% call message_box('highlight', icon=true) %}
            <div class="content smaller">
                <span class="js-show-message">
                    {% trans %}Some events in the list below have been hidden.{% endtrans %}
                </span>
            </div>
        {% endcall %}
    {% endif %}

    <ind-event-list
        show-future-events="{{ show_future_events|tojson }}"
        is-flat="{{ is_flat|tojson }}"
    >
        <section id="event-list" aria-labelledby="events-by-month">
            <h2 id="events-by-month"
                data-bypass-target="{% trans %}Skip to event list{% endtrans %}">{% trans %}Events by month{% endtrans %}</h2>{% if future_event_count %}
                <ind-hidden-event-trigger list-name="future"
                                          url="{{ url_for('.show_future_events', category) }}"
                                          shown="{{ show_future_events|tojson }}"
                >
                    <button value="show">
                        {%- trans count=future_event_count -%}
                            Show {{ future_event_count }} future event
                        {%- pluralize -%}
                            Show {{ future_event_count }} future events
                        {%- endtrans -%}
                    </button>
                    <button value="hide">{% trans %}Hide future events{% endtrans %}</button>
                    <p aria-live="polite"
                       data-loading-message="{% trans %}Loading future events{% endtrans %}"
                       data-error-message="{% trans %}Future events could not be loaded due to an error.{% endtrans %}"
                       data-loaded-message="{% trans count=future_event_count %}Showing {{ future_event_count }} future event.{% pluralize %}Showing {{ future_event_count }} events.{% endtrans %}"
                    ></p>
                    <ind-hidden-event-list list-name="future"
                                           url="{{ url_for('.event_list', category) }}"
                                           after="{{ future_threshold }}"
                                           flat="{{ is_flat|tojson }}"
                                           extra-params="{{ request_params|tojson }}"
                                           hidden
                    ></ind-hidden-event-list>
                </ind-hidden-event-trigger>
            {% endif %}
            {{ event_list_block(events_by_month, format_event_date, is_recent, happening_now) }}
            {% if past_event_count %}
                <ind-hidden-event-trigger list-name="past"
                                          url="{{ url_for('.show_past_events', category) }}"
                                          shown="{{ show_past_events|tojson }}"
                >
                    {# XXX: The 'show' button is above the list because of the focus order. #}
                    <button value="show">
                        {%- trans count=past_event_count -%}
                            Show {{ past_event_count }} past event
                            {%- pluralize -%}
                            Show {{ past_event_count }} past events
                        {%- endtrans -%}
                    </button>
                    <ind-hidden-event-list list-name="past"
                                           url="{{ url_for('.event_list', category) }}"
                                           before="{{ past_threshold }}"
                                           flat="{{ is_flat|tojson }}"
                                           extra-params="{{ request_params|tojson }}"
                                           hidden
                    ></ind-hidden-event-list>
                    <button value="hide" hidden>{% trans %}Hide past events{% endtrans %}</button>
                    <p aria-live="polite"
                       data-loading-message="{% trans %}Loading past events.{% endtrans %}"
                       data-error-message="{% trans %}Past events could not be loaded due to an error.{% endtrans %}"
                       data-loaded-message="{% trans count=past_event_count %}Showing {{ past_event_count }} past event.{% pluralize %}Showing {{ past_event_count }} events.{% endtrans %}"
                    ></p>
                </ind-hidden-event-trigger>
            {% endif %}
        </section>
    </ind-event-list>
{% endmacro %}

{% macro event_list_block(events_by_month, format_event_date, is_recent, happening_now) %}
    {% for month in events_by_month %}
        <section aria-labelledby="month-events-{{ month.iso_date }}">
            <h3 id="month-events-{{ month.iso_date }}" class="{% if month.is_current %}current-month{% endif %}">
                <time datetime="{{ month.iso_date }}">{{ month.name }}</time>
            </h3>
            <ul>
                {% for event in month.events %}
                    {% set is_lecture = (event.type == 'lecture') %}
                    {% set event_title = event.get_verbose_title(show_speakers=is_lecture, show_series_pos=is_lecture) %}
                    {% set is_favorite = session.user and event in session.user.favorite_events %}
                    <li>
                        <div class="event-date">
                            <ind-with-tooltip>
                                <a class="download-event" href="{{ url_for('events.export_event_ical', event) }}"
                                   download>
                                    <span data-tip-content>{% trans %}Download event details for
                                        {{ event_title }}{% endtrans %}</span>
                                </a>
                            </ind-with-tooltip>
                            <span class="date {% if happening_now(event) %}ongoing{% endif %}">
                                {{ format_event_date(event) }}
                            </span>
                        </div>
                        <div class="event-title">
                            <a href="{{ event.url }}">
                                {{ event_title | striptags }}
                            </a>
                            {% if is_favorite %}
                                <span class="favorite-event">
                                    <span>{% trans %}Favorite event{% endtrans %}</span>
                                </span>
                            {% endif %}
                            {% if event.is_self_protected %}
                                <span class="protected" data-type="restricted">
                                    <span>{% trans %}Protected{% endtrans %}</span>
                                </span>
                            {% endif %}
                        </div>
                        <span class="event-labels">
                            {% if event.visibility == 0 %}
                                <span class="hidden-event-label">{% trans %}hidden{% endtrans %}</span>
                            {% endif %}
                            {% if is_recent(event.created_dt) %}
                                <span class="new-event-label">{% trans %}new{% endtrans %}</span>
                            {% endif %}
                            {{ template_hook('event-status-labels', event=event) }}
                            {% if event.label %}
                                <span class="custom-event-label" data-color="{{ event.label.color }}">
                                    <span>{{- event.label.title -}}</span>
                                    {% if event.label_message %}
                                        <ind-with-toggletip>
                                            <button>
                                                <span>{% trans %}More information{% endtrans %}</span>
                                            </button>
                                            <span data-tip-content aria-live="polite">
                                                {{ event.label_message }}
                                            </span>
                                        </ind-with-toggletip>
                                    {% endif %}
                                </span>
                            {% endif %}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        </section>
    {% endfor %}
{% endmacro %}
