{% from 'events/_affiliation.html' import render_affiliation %}

{% macro render_location(item, parent=none, class='item-location', header=false) -%}
    {% set show_venue = not parent or (parent.venue_name != item.venue_name) %}
    {% set show_room = item.room_name != '' %}
    {% if show_venue or show_room %}
        <span class="location-info {{ class }}">
            <i class="icon-location {{ 'header-data' if header }}"></i>
            <span class="text">
                {%- if show_venue and show_room -%}
                    {{ item.room_name }}{% if item.venue_name %} ({{ item.venue_name }}){% endif %}
                {%- elif show_venue -%}
                    {{ item.venue_name }}
                {%- else -%}
                    {{ item.room_name }}
                {%- endif -%}
            </span>

            {% set tip_content %}
                <div data-tip-content>
                    {% if item.address %}
                        <address class="location-address">{{ item.address }}</address>
                    {% endif %}

                    {% if item.room.capacity %}
                        <div class="room-capacity">
                            <span>{% trans %}Capacity:{% endtrans %}</span>
                            {{ item.room.capacity }}
                        </div>
                    {% endif %}
                </div>
            {% endset %}

            {% if item.map_url or item.room and item.room.map_url %}
                <ind-with-tooltip>
                    <a href="{{ item.map_url or item.room.map_url }}" class="map-link" target="_blank">
                        <span>{% trans %}Show location on the map{% endtrans %}</span>
                        (missing icon)
                    </a>
                    {{ tip_content }}
                </ind-with-tooltip>
            {% else %}
                <ind-with-toggletip>
                    <button>
                        <span>{% trans %}Show location details{% endtrans %}</span>
                    </button>
                    {{ tip_content }}
                </ind-with-toggletip>
            {% endif %}
        </span>
    {% endif %}
{%- endmacro %}

{% macro render_user_data(user_data, show_title=true) -%}
    {% if user_data.title and show_title -%}
        <span class="speaker-title">
            {{- user_data.title -}}
        </span>
    {%- endif %}
    <span>{{ user_data.display_full_name }}</span>
    {%- if user_data.affiliation %}
        <span class="affiliation">
            <span class="text">({{ render_affiliation(user_data) }})</span>{#--#}
        </span>
    {%- endif %}
{%- endmacro %}

{% macro render_users(user_list, span_class='', title=true, separator=', ') -%}
    {%- for link in user_list -%}
        {%- if caller is defined -%}
            {{- caller(link) -}}
        {%- else -%}
            <span class="{{ span_class }}">
                {{- render_user_data(link, show_title=title) -}}
            </span>
        {%- endif -%}
        {%- if not loop.last -%}
            {{- separator -}}
        {%- endif -%}
    {%- endfor -%}
{%- endmacro %}

{% macro render_speakers(contribution) %}
    <section>
        <div class="header">
            <div class="header-row">
                <h3>
                    {%- trans count=contribution.speakers|length -%}
                        Speaker
                        {%- pluralize -%}
                        Speakers
                    {%- endtrans -%}
                </h3>
            </div>
        </div>
        <div class="speaker-list">
            {{ render_users(contribution.speakers|sort(attribute='display_order_key'),
                            span_class='speaker-item icon-user', separator='') }}
        </div>
    </section>
{% endmacro %}

{% macro render_datetime(prop_name, dt, timezone, format='medium', show_weekday=false) -%}
    <time itemprop="{{ prop_name }}" datetime="{{ dt.isoformat() }}">
        {% if show_weekday %}
            {{ dt | format_datetime(format='EEEE', timezone=timezone) }}
        {% endif %}
        {{ dt | format_datetime(format=format, timezone=timezone) }}
    </time>
{%- endmacro %}

{% macro render_event_time(event, timezone) -%}
    <i class="icon-calendar header-data" title="{% trans %}Start/end date/time of the event{% endtrans %}"></i>
    {% if event.start_dt.astimezone(timezone).date() == event.end_dt.astimezone(timezone).date() %}
        {% set start_time = event.start_dt | format_datetime('medium', timezone=timezone) %}
        {% set end_time = event.end_dt | format_time('medium', timezone=timezone) %}
        <span class="event-time-data"
              aria-label="{% trans %}{{ start_time }} to {{ end_time }} ({{ timezone }}){% endtrans %}">
                {{ render_datetime('startDate', event.start_dt, timezone=timezone, show_weekday=true) }}
                &rarr;
                <time itemprop="endDate" datetime="{{ event.end_dt.isoformat() }}">
                    {{ event.end_dt | format_time(format='medium', timezone=timezone) }}
                </time>
            <span class="timezone">{{ timezone }}</span>
        </span>
    {% else %}
        {% set start_time = event.start_dt | format_datetime('medium', timezone=timezone) %}
        {% set end_time = event.end_dt | format_datetime('medium', timezone=timezone) %}
        <span class="event-time-data"
              aria-label="{% trans %}{{ start_time }} to {{ end_time }} ({{ timezone }}){% endtrans %}">
            {%- set show_weekday = event.type == 'lecture' -%}
            {{ render_datetime('startDate', event.start_dt, timezone=timezone, show_weekday=show_weekday) }}
            &rarr;
            {{ render_datetime('endDate', event.end_dt, timezone=timezone, show_weekday=show_weekday) }}
            <span class="timezone">{{ timezone }}</span>
        </span>
    {% endif %}
{%- endmacro %}
